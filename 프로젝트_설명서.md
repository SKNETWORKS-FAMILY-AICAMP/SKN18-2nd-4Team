# ⚽ Football Transfer Prediction - 프로젝트 상세 설명서

## 📋 프로젝트 개요

이 프로젝트는 **Football Transfermarkt 데이터**를 활용하여 **선수의 이적 확률을 예측**하는 머신러닝 모델을 구축합니다.

### 🎯 핵심 목표

1. **23/24 시즌 선수들의 이적 확률 예측**
2. **데이터 누수 없는 시간순 분할** (과거→미래)
3. **하이브리드 인코딩 전략** (라벨 + 원핫 인코딩)
4. **다양한 모델 성능 비교 및 최적화**

---

## 📊 데이터 구조 및 선택 이유

### Raw 데이터 (data/raw/) - 10개 파일

#### 1. **players.csv** - 선수 기본 정보

```csv
player_id, name, date_of_birth, height_in_cm, foot, country_of_birth
```

**선택 이유**: 선수의 개인적 특성 (나이, 키, 발 선호도, 국적)이 이적에 영향을 미침

#### 2. **clubs.csv** - 클럽 정보

```csv
club_id, name, domestic_competition_id
```

**선택 이유**: 클럽별 특성과 선수 이적의 상관관계 분석

#### 3. **appearances.csv** - 출전 기록

```csv
appearance_id, game_id, player_id, player_club_id, player_name, competition_id, yellow_cards, red_cards, goals, assists, minutes_played
```

**선택 이유**: 선수의 경기 출전 시간, 성과가 이적에 미치는 영향

#### 4. **player_valuations.csv** - 시장가치 변동

```csv
player_id, last_season, datetime, date, dateweek, market_value_in_eur, current_club_id, player_club_domestic_competition_id
```

**선택 이유**: 시장가치가 이적 확률에 가장 중요한 지표

#### 5. **transfers.csv** - 이적 기록

```csv
transfer_id, player_id, player_name, season, date, from_club_name, to_club_name, market_value_in_eur, transfer_fee_in_eur
```

**선택 이유**: 타겟 변수(transfer) 생성의 기준

#### 6. **games.csv** - 경기 정보

```csv
game_id, competition_id, season, round, date, home_club_id, away_club_id, home_club_goals, away_club_goals, home_club_position, away_club_position
```

**선택 이유**: 클럽의 성과와 선수 이적의 상관관계

#### 7. **competitions.csv** - 대회 정보

```csv
competition_id, competition_name, competition_type, country_name, country_code, confederation
```

**선택 이유**: 대회별 특성 분석

#### 8. **club_games.csv** - 클럽별 경기 기록

```csv
game_id, club_id, own_goals, own_position, own_manager_name, opponent_id, opponent_goals, opponent_position, opponent_manager_name, hosting, is_win
```

**선택 이유**: 클럽의 성과 지표

#### 9. **game_events.csv** - 경기 이벤트

```csv
event_id, game_id, minute, type, club_id, player_id, description, player_in_id, player_out_id
```

**선택 이유**: 선수의 세부 성과 분석

#### 10. **game_lineups.csv** - 경기 라인업

```csv
game_id, club_id, player_id, type, number, position
```

**선택 이유**: 포지션별 분석

### Curated 데이터 (data/curated/) - 통합 데이터

#### **player_final.csv** - 최종 통합 데이터셋

```csv
season, player_name, goals, assists, yellow_cards, red_cards, season_avg_minutes,
player_market_value_in_eur, club_squad_size, club_average_age, club_foreigners_percentage,
club_national_team_players, player_highest_market_value_in_eur, club_name,
country_of_birth, date_of_birth, foot, height_in_cm, agent_name, net_transfer_record,
position, sub_position, season_win_count, transfer
```

**통합 과정**:

1. **시즌별 그룹화**: 각 선수별로 시즌별 데이터 집계
2. **클럽 정보 통합**: 클럽별 통계 (평균 나이, 외국인 비율 등)
3. **성과 지표 계산**: 골, 어시스트, 출전시간 등
4. **타겟 변수 생성**: transfer (0: 유지, 1: 이적)

---

## 🔧 데이터 전처리 과정

### 1. 기본 피처 엔지니어링

#### **시즌 정보**

```python
# 시즌 시작 연도 계산
df_model['season_start_year'] = df_model['season'].apply(lambda x: 2000 + int(x.split('/')[0]))
```

**이유**: 시간순 분석을 위한 연도 정보

#### **나이 계산**

```python
# 생년월일에서 나이 계산
by = df_model['date_of_birth'].astype(str).str.extract(r"^(\d{4})")[0]
birth_year = pd.to_numeric(by, errors='coerce')
df_model['age_at_season'] = (df_model['season_start_year'] - birth_year).astype('float')
```

**이유**: 나이는 이적에 중요한 요인 (젊은 선수일수록 이적 확률 높음)

#### **로그 시장가치**

```python
# 시장가치 로그 변환
df_model['log_market_value'] = np.log1p(pd.to_numeric(df_model['player_market_value_in_eur'], errors='coerce'))
```

**이유**: 시장가치 분포가 왜곡되어 있어 로그 변환으로 정규화

### 2. 고급 피처 엔지니어링 (8개)

#### **1. minutes_vs_club_avg**

```python
# 개인 출전시간 / 클럽 평균 출전시간
df_model['minutes_vs_club_avg'] = df_model['season_avg_minutes'] / df_model.groupby(['club_name', 'season'])['season_avg_minutes'].transform('mean')
```

**의미**: 클럽 내 상대적 중요도

#### **2. age_difference**

```python
# 개인 나이 - 클럽 평균 나이
df_model['age_difference'] = df_model['age_at_season'] - df_model.groupby(['club_name', 'season'])['age_at_season'].transform('mean')
```

**의미**: 클럽 내 나이대별 위치

#### **3. attack_contribution**

```python
# (골 + 어시스트) × 시즌 승수
df_model['attack_contribution'] = (df_model['goals'] + df_model['assists']) * df_model['season_win_count']
```

**의미**: 공격 기여도와 팀 성과의 상호작용

#### **4. is_foreigner**

```python
# 외국인 여부 (영국 출생 제외)
df_model['is_foreigner'] = (df_model['country_of_birth'] != 'England').astype(int)
```

**의미**: 외국인 선수의 이적 특성

#### **5. height_vs_position**

```python
# 포지션별 키 상대비
position_height_avg = df_model.groupby('position')['height_in_cm'].transform('mean')
df_model['height_vs_position'] = df_model['height_in_cm'] / position_height_avg
```

**의미**: 포지션별 키 적합성

#### **6. cards_per_minute**

```python
# 카드 수 / 출전시간
df_model['cards_per_minute'] = (df_model['yellow_cards'] + df_model['red_cards']) / (df_model['season_avg_minutes'] + 1)
```

**의미**: 경기 태도와 규율성

#### **7. club_tenure_seasons**

```python
# 클럽 재적 기간
df_model['club_tenure_seasons'] = df_model.groupby('player_name')['season'].transform('count')
```

**의미**: 클럽에 대한 충성도

#### **8. position_competition**

```python
# 포지션 내 경쟁도
df_model['position_competition'] = df_model.groupby(['club_name', 'season', 'position'])['player_name'].transform('count')
```

**의미**: 포지션별 경쟁 강도

### 3. 인코딩 전략

#### **하이브리드 인코딩**

```python
# 순서가 있는 변수 (라벨 인코딩)
ordinal_features = ['season']  # 시간 순서

# 순서가 없는 변수 (원핫 인코딩)
nominal_features = [
    'club_name', 'country_of_birth', 'foot',
    'position', 'sub_position'  # 포지션은 순서 없음
]

# 수치형 변수 (스케일링)
numeric_features = [기타 수치형 컬럼들]
```

**선택 이유**:

- **라벨 인코딩**: 시즌은 시간 순서가 있음
- **원핫 인코딩**: 포지션, 클럽 등은 순서가 없음
- **스케일링**: 수치형 변수들의 스케일 통일

### 4. 결측치 처리

```python
# 수치형: median (중앙값)
# 범주형: most_frequent (최빈값)
# 새로운 라벨: -1 (라벨 인코딩에서)
```

**선택 이유**:

- **중앙값**: 이상치에 강함
- **최빈값**: 범주형에서 가장 일반적
- **-1**: 새로운 라벨을 명시적으로 처리

---

## 🤖 모델링 과정

### 1. 데이터 분할 (시간순)

```python
# 훈련: 12/13 ~ 21/22 (10개 시즌)
# 테스트: 22/23 (1개 시즌)
# 예측: 23/24 (1개 시즌)
```

**시간순 분할 이유**:

- **현실성**: 과거 데이터로 미래 예측
- **데이터 누수 방지**: 미래 정보로 과거 예측 금지
- **시계열 특성**: 시간에 따른 패턴 변화 반영

### 2. 모델 비교

#### **8개 모델 비교**

```python
models = {
    'Logistic Regression': LogisticRegression(class_weight='balanced'),
    'Random Forest': RandomForestClassifier(class_weight='balanced'),
    'Gradient Boosting': GradientBoostingClassifier(),
    'SVM': SVC(class_weight='balanced', probability=True),
    'KNN': KNeighborsClassifier(),
    'Decision Tree': DecisionTreeClassifier(class_weight='balanced'),
    'XGBoost': XGBClassifier(scale_pos_weight=pos_weight),
    'LightGBM': LGBMClassifier(class_weight='balanced')
}
```

**모델 선택 이유**:

- **다양성**: 선형, 트리, 앙상블 모델 포함
- **클래스 불균형**: class_weight='balanced' 적용
- **확률 예측**: probability=True로 확률 출력

### 3. 평가 지표

#### **복합 점수 (가중평균)**

```python
composite_score = AUC * 0.4 + F1 * 0.3 + Precision * 0.2 + Recall * 0.1
```

**가중치 선택 이유**:

- **AUC (40%)**: 전체적인 분류 성능
- **F1 (30%)**: 정밀도와 재현율의 균형
- **Precision (20%)**: 이적 예측의 정확성
- **Recall (10%)**: 이적 선수 발견율

#### **개별 지표**

- **Accuracy**: 전체 정확도
- **Precision**: 이적 예측 중 실제 이적 비율
- **Recall**: 실제 이적 중 예측 성공 비율
- **F1-Score**: 정밀도와 재현율의 조화평균
- **AUC**: ROC 곡선 아래 면적

### 4. 하이퍼파라미터 튜닝

```python
# GridSearchCV 사용
param_grid = {
    'n_estimators': [50, 100, 200],
    'max_depth': [10, 20, 30, None],
    'min_samples_split': [2, 5, 10],
    'min_samples_leaf': [1, 2, 4]
}
```

**튜닝 이유**:

- **과적합 방지**: max_depth, min_samples 제한
- **성능 최적화**: n_estimators 조정
- **교차 검증**: 5-Fold로 안정성 확보

### 5. 교차 검증

```python
# 5-Fold Stratified K-Fold
cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

# Pipeline 사용 (데이터 누수 방지)
pipeline = Pipeline([
    ('preprocessor', preprocessor),
    ('classifier', model)
])
```

**Pipeline 사용 이유**:

- **데이터 누수 방지**: 각 fold마다 전처리 재적용
- **일관성**: 훈련과 테스트에 동일한 전처리
- **안정성**: 전처리 과정의 재현성

---

## 📈 결과 해석

### 1. 모델 성능

#### **최적 모델**: Random Forest

- **복합 점수**: 0.85+
- **AUC**: 0.90+
- **F1-Score**: 0.80+

#### **성능이 좋은 이유**:

- **트리 기반**: 비선형 관계 잘 포착
- **앙상블**: 과적합 방지
- **피처 중요도**: 해석 가능

### 2. 피처 중요도 (SHAP)

#### **상위 중요 피처**:

1. **log_market_value**: 시장가치 (가장 중요)
2. **season_avg_minutes**: 출전시간
3. **age_at_season**: 나이
4. **position**: 포지션
5. **club_average_age**: 클럽 평균 나이

#### **피처별 해석**:

- **시장가치**: 높을수록 이적 확률 높음
- **출전시간**: 적을수록 이적 확률 높음
- **나이**: 20-25세에서 이적 확률 높음
- **포지션**: 미드필더, 공격수 위험도 높음

### 3. 23/24 예측 결과

#### **예측 결과 파일**: `data/processed/23_24_transfer_predictions.csv`

```csv
player_name,club_name,position,predicted_transfer,transfer_probability_percent
Lesley Ugochukwu,Chelsea Football Club,Midfield,1,97.0
Roméo Lavia,Chelsea Football Club,Midfield,1,96.8
...
```

#### **결과 해석**:

- **고위험 선수**: 확률 ≥60% (특별 관리 대상)
- **포지션별**: 미드필더, 공격수 위험도 높음
- **연령대별**: 20-25세 이적 위험 높음

---

## ⚠️ 주의사항 및 한계

### 1. 데이터 누수 방지

#### **시간순 분할**

- **과거→미래**: 12/13~21/22 → 22/23 → 23/24
- **미래 정보 금지**: 23/24 데이터로 과거 예측 금지

#### **Pipeline 사용**

- **CV에서 전처리**: 각 fold마다 전처리 재적용
- **class_weight**: y_train 기준으로만 계산

### 2. 클래스 불균형

#### **문제**: 이적률 15.2% (불균형)

#### **해결책**:

- **class_weight='balanced'**: 자동 가중치 조정
- **복합 점수**: AUC와 F1 점수 균형 고려

### 3. 모델 한계

#### **데이터 한계**:

- **시장가치**: 주관적 평가 포함
- **이적 기록**: 실제 이적만 기록 (임대 제외)
- **시즌별 변화**: 코로나19 등 외부 요인

#### **모델 한계**:

- **과거 패턴**: 미래 변화 예측 어려움
- **외부 요인**: 코로나19, 경제 상황 등 미반영
- **개인적 요인**: 가족, 개인적 사정 등 미반영

---

## 🔮 비즈니스 인사이트

### 1. 고위험 선수 식별

#### **확률 ≥60%**: 특별 관리 대상

- **조기 재계약**: 이적 전 재계약 시도
- **임대 제안**: 이적 위험 완화
- **인센티브 설계**: 성과 연계 보상

#### **포지션별 전략**:

- **미드필더**: 핵심 선수 확보
- **공격수**: 백업 선수 준비
- **수비수**: 안정성 유지

### 2. 클럽 전략

#### **스쿼드 관리**:

- **연령대별**: 젊은 선수 위주 구성
- **포지션별**: 경쟁력 있는 포지션 확보
- **국적별**: 외국인 선수 비율 조절

#### **재정 관리**:

- **시장가치**: 선수 가치 모니터링
- **이적료**: 예상 이적료 산정
- **보상금**: 이적 방지 비용 계산

### 3. 모니터링 시스템

#### **월간 업데이트**:

- **시장가치**: Transfermarkt 데이터 갱신
- **출전시간**: 경기 출전 현황
- **성과 지표**: 골, 어시스트, 카드 등

#### **경고 시스템**:

- **위험도 임계값**: 60% 초과 시 알림
- **트렌드 분석**: 위험도 변화 추적
- **비용 분석**: 이적 방지 vs 이적 비용

---

## 📞 문의사항

프로젝트 관련 문의사항이 있으시면 언제든 연락주세요!

---

_이 프로젝트는 Football Transfermarkt 데이터를 활용한 선수 이적 예측 모델링 프로젝트입니다._
